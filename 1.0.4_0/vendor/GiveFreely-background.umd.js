!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).GiveFreely={})}(this,(function(e){"use strict";class t{log({level:e,message:r,timestamp:i,data:s,title:a}){const n="debug"===e?"log":e,o=a?`[${a}]`:"";void 0!==s?console[n](`[${i}] - ${t.LOGGER_PREFIX} ${o} ${r}`,s):console[n](`[${i}] - ${t.LOGGER_PREFIX} ${o} ${r}`)}}var r,i;t.LOGGER_PREFIX="[GFAdUnit] -",function(e){e.checkoutPopupShown="CHECKOUT-POPUP-SHOWN",e.checkoutPopupNotShown="CHECKOUT-POPUP-NOT-SHOWN",e.checkoutPopupSupressed="CHECKOUT-POPUP-SUPRESSED",e.checkoutPopupDonation="CHECKOUT-POPUP-DONATION",e.checkoutPopupFailedActivation="CHECKOUT-POPUP-FAILED-ACTIVATION",e.checkoutPopupPurchaseConfirmed="CHECKOUT-POPUP-PURCHASE-CONFIRMED",e.checkoutPopupHealthCheck="CHECKOUT-POPUP-HEALTH-CHECK",e.checkouPopupActivationFailed="CHECKOUT-POPUP-ACTIVATION-FAILED",e.checkoutPopupOfferDetailsClicked="CHECKOUT-POPUP-OFFER-DETAILS-CLICKED",e.checkoutPopupWhyAmISeeingThisClicked="CHECKOUT-POPUP-WHY-AM-I-SEEING-THIS-CLICKED",e.checkoutPopupLooserExtension="CHECKOUT-POPUP-LOOSER-EXTENSION",e.checkoutPopupActiveDomain="CHECKOUT-POPUP-ACTIVE-DOMAIN",e.checkoutPopupSiteMatches="CHECKOUT-POPUP-SITE-MATCHES"}(r||(r={})),function(e){e.adUnitLog="ADUNIT-LOG"}(i||(i={}));class s{constructor(e){this.gfService=e}log({level:e,message:t,data:r,title:s}){this.gfService.trackEvent(i.adUnitLog,{log:{level:e,message:t,data:r,title:s}})}}const a=["debug","info","warn","error"];class n{constructor(e){this.config={minLevel:e?.minLevel??"debug",enabled:e?.enabled??!1,transports:e?.transports??[new t],title:e?.title??""}}static getInstance(e){return n.instance||(n.instance=new n(e)),n.instance}configure(e){this.config={...this.config,...e}}shouldLog(e){return!!this.config.enabled&&a.indexOf(e)>=a.indexOf(this.config.minLevel)}createLogMessage(e,t,r){return{level:e,version:"1.5.1",message:t,timestamp:(new Date).toISOString(),data:r,title:this.config.title}}log(e,t,r){if(!this.shouldLog(e))return;const i=this.createLogMessage(e,t,r);this.config.transports.forEach((e=>e.log(i)))}debug(e,t){this.log("debug",e,t)}info(e,t){this.log("info",e,t)}warn(e,t){this.log("warn",e,t)}error(e,t){this.log("error",e,t)}addTransport(e){this.config.transports.push(e)}clearTransports(){this.config.transports=[]}disable(){this.config.enabled=!1}enable(){this.config.enabled=!0}}const o=3,c=e=>1e3*e;async function g(e,t={}){const{maxAttempts:r=o,delayFn:i=c}=t;let s=null;for(let t=1;t<=r;t+=1)try{return await e()}catch(e){s=e,t<r&&await new Promise((e=>{setTimeout(e,i(t))}))}throw s||new Error("Operation failed after multiple attempts")}const l=chrome;function h(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self&&self;var d={exports:{}};!function(e){"undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self&&self,function(e){if(!(globalThis.chrome&&globalThis.chrome.runtime&&globalThis.chrome.runtime.id))throw new Error("This script should only be loaded in a browser extension.");if(globalThis.browser&&globalThis.browser.runtime&&globalThis.browser.runtime.id)e.exports=globalThis.browser;else{const t="The message port closed before a response was received.",r=e=>{const r={alarms:{clear:{minArgs:0,maxArgs:1},clearAll:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getAll:{minArgs:0,maxArgs:0}},bookmarks:{create:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},getChildren:{minArgs:1,maxArgs:1},getRecent:{minArgs:1,maxArgs:1},getSubTree:{minArgs:1,maxArgs:1},getTree:{minArgs:0,maxArgs:0},move:{minArgs:2,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeTree:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}},browserAction:{disable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},enable:{minArgs:0,maxArgs:1,fallbackToNoCallback:!0},getBadgeBackgroundColor:{minArgs:1,maxArgs:1},getBadgeText:{minArgs:1,maxArgs:1},getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},openPopup:{minArgs:0,maxArgs:0},setBadgeBackgroundColor:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setBadgeText:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},browsingData:{remove:{minArgs:2,maxArgs:2},removeCache:{minArgs:1,maxArgs:1},removeCookies:{minArgs:1,maxArgs:1},removeDownloads:{minArgs:1,maxArgs:1},removeFormData:{minArgs:1,maxArgs:1},removeHistory:{minArgs:1,maxArgs:1},removeLocalStorage:{minArgs:1,maxArgs:1},removePasswords:{minArgs:1,maxArgs:1},removePluginData:{minArgs:1,maxArgs:1},settings:{minArgs:0,maxArgs:0}},commands:{getAll:{minArgs:0,maxArgs:0}},contextMenus:{remove:{minArgs:1,maxArgs:1},removeAll:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},cookies:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:1,maxArgs:1},getAllCookieStores:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},devtools:{inspectedWindow:{eval:{minArgs:1,maxArgs:2,singleCallbackArg:!1}},panels:{create:{minArgs:3,maxArgs:3,singleCallbackArg:!0},elements:{createSidebarPane:{minArgs:1,maxArgs:1}}}},downloads:{cancel:{minArgs:1,maxArgs:1},download:{minArgs:1,maxArgs:1},erase:{minArgs:1,maxArgs:1},getFileIcon:{minArgs:1,maxArgs:2},open:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},pause:{minArgs:1,maxArgs:1},removeFile:{minArgs:1,maxArgs:1},resume:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},extension:{isAllowedFileSchemeAccess:{minArgs:0,maxArgs:0},isAllowedIncognitoAccess:{minArgs:0,maxArgs:0}},history:{addUrl:{minArgs:1,maxArgs:1},deleteAll:{minArgs:0,maxArgs:0},deleteRange:{minArgs:1,maxArgs:1},deleteUrl:{minArgs:1,maxArgs:1},getVisits:{minArgs:1,maxArgs:1},search:{minArgs:1,maxArgs:1}},i18n:{detectLanguage:{minArgs:1,maxArgs:1},getAcceptLanguages:{minArgs:0,maxArgs:0}},identity:{launchWebAuthFlow:{minArgs:1,maxArgs:1}},idle:{queryState:{minArgs:1,maxArgs:1}},management:{get:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},getSelf:{minArgs:0,maxArgs:0},setEnabled:{minArgs:2,maxArgs:2},uninstallSelf:{minArgs:0,maxArgs:1}},notifications:{clear:{minArgs:1,maxArgs:1},create:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:0},getPermissionLevel:{minArgs:0,maxArgs:0},update:{minArgs:2,maxArgs:2}},pageAction:{getPopup:{minArgs:1,maxArgs:1},getTitle:{minArgs:1,maxArgs:1},hide:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setIcon:{minArgs:1,maxArgs:1},setPopup:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},setTitle:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0},show:{minArgs:1,maxArgs:1,fallbackToNoCallback:!0}},permissions:{contains:{minArgs:1,maxArgs:1},getAll:{minArgs:0,maxArgs:0},remove:{minArgs:1,maxArgs:1},request:{minArgs:1,maxArgs:1}},runtime:{getBackgroundPage:{minArgs:0,maxArgs:0},getPlatformInfo:{minArgs:0,maxArgs:0},openOptionsPage:{minArgs:0,maxArgs:0},requestUpdateCheck:{minArgs:0,maxArgs:0},sendMessage:{minArgs:1,maxArgs:3},sendNativeMessage:{minArgs:2,maxArgs:2},setUninstallURL:{minArgs:1,maxArgs:1}},sessions:{getDevices:{minArgs:0,maxArgs:1},getRecentlyClosed:{minArgs:0,maxArgs:1},restore:{minArgs:0,maxArgs:1}},storage:{local:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}},managed:{get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1}},sync:{clear:{minArgs:0,maxArgs:0},get:{minArgs:0,maxArgs:1},getBytesInUse:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}}},tabs:{captureVisibleTab:{minArgs:0,maxArgs:2},create:{minArgs:1,maxArgs:1},detectLanguage:{minArgs:0,maxArgs:1},discard:{minArgs:0,maxArgs:1},duplicate:{minArgs:1,maxArgs:1},executeScript:{minArgs:1,maxArgs:2},get:{minArgs:1,maxArgs:1},getCurrent:{minArgs:0,maxArgs:0},getZoom:{minArgs:0,maxArgs:1},getZoomSettings:{minArgs:0,maxArgs:1},goBack:{minArgs:0,maxArgs:1},goForward:{minArgs:0,maxArgs:1},highlight:{minArgs:1,maxArgs:1},insertCSS:{minArgs:1,maxArgs:2},move:{minArgs:2,maxArgs:2},query:{minArgs:1,maxArgs:1},reload:{minArgs:0,maxArgs:2},remove:{minArgs:1,maxArgs:1},removeCSS:{minArgs:1,maxArgs:2},sendMessage:{minArgs:2,maxArgs:3},setZoom:{minArgs:1,maxArgs:2},setZoomSettings:{minArgs:1,maxArgs:2},update:{minArgs:1,maxArgs:2}},topSites:{get:{minArgs:0,maxArgs:0}},webNavigation:{getAllFrames:{minArgs:1,maxArgs:1},getFrame:{minArgs:1,maxArgs:1}},webRequest:{handlerBehaviorChanged:{minArgs:0,maxArgs:0}},windows:{create:{minArgs:0,maxArgs:1},get:{minArgs:1,maxArgs:2},getAll:{minArgs:0,maxArgs:1},getCurrent:{minArgs:0,maxArgs:1},getLastFocused:{minArgs:0,maxArgs:1},remove:{minArgs:1,maxArgs:1},update:{minArgs:2,maxArgs:2}}};if(0===Object.keys(r).length)throw new Error("api-metadata.json has not been included in browser-polyfill");class i extends WeakMap{constructor(e,t=void 0){super(t),this.createItem=e}get(e){return this.has(e)||this.set(e,this.createItem(e)),super.get(e)}}const s=(t,r)=>(...i)=>{e.runtime.lastError?t.reject(new Error(e.runtime.lastError.message)):r.singleCallbackArg||i.length<=1&&!1!==r.singleCallbackArg?t.resolve(i[0]):t.resolve(i)},a=e=>1==e?"argument":"arguments",n=(e,t,r)=>new Proxy(t,{apply:(t,i,s)=>r.call(i,e,...s)});let o=Function.call.bind(Object.prototype.hasOwnProperty);const c=(e,t={},r={})=>{let i=Object.create(null),g={has:(t,r)=>r in e||r in i,get(g,l,h){if(l in i)return i[l];if(!(l in e))return;let d=e[l];if("function"==typeof d)if("function"==typeof t[l])d=n(e,e[l],t[l]);else if(o(r,l)){let t=((e,t)=>function(r,...i){if(i.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${a(t.minArgs)} for ${e}(), got ${i.length}`);if(i.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${a(t.maxArgs)} for ${e}(), got ${i.length}`);return new Promise(((a,n)=>{if(t.fallbackToNoCallback)try{r[e](...i,s({resolve:a,reject:n},t))}catch(s){console.warn(`${e} API method doesn't seem to support the callback parameter, falling back to call it without a callback: `,s),r[e](...i),t.fallbackToNoCallback=!1,t.noCallback=!0,a()}else t.noCallback?(r[e](...i),a()):r[e](...i,s({resolve:a,reject:n},t))}))})(l,r[l]);d=n(e,e[l],t)}else d=d.bind(e);else if("object"==typeof d&&null!==d&&(o(t,l)||o(r,l)))d=c(d,t[l],r[l]);else{if(!o(r,"*"))return Object.defineProperty(i,l,{configurable:!0,enumerable:!0,get:()=>e[l],set(t){e[l]=t}}),d;d=c(d,t[l],r["*"])}return i[l]=d,d},set:(t,r,s,a)=>(r in i?i[r]=s:e[r]=s,!0),defineProperty:(e,t,r)=>Reflect.defineProperty(i,t,r),deleteProperty:(e,t)=>Reflect.deleteProperty(i,t)},l=Object.create(e);return new Proxy(l,g)},g=e=>({addListener(t,r,...i){t.addListener(e.get(r),...i)},hasListener:(t,r)=>t.hasListener(e.get(r)),removeListener(t,r){t.removeListener(e.get(r))}}),l=new i((e=>"function"!=typeof e?e:function(t){const r=c(t,{},{getContent:{minArgs:0,maxArgs:0}});e(r)})),h=new i((e=>"function"!=typeof e?e:function(t,r,i){let s,a,n=!1,o=new Promise((e=>{s=function(t){n=!0,e(t)}}));try{a=e(t,r,s)}catch(e){a=Promise.reject(e)}const c=!0!==a&&((g=a)&&"object"==typeof g&&"function"==typeof g.then);var g;if(!0!==a&&!c&&!n)return!1;return(c?a:o).then((e=>{i(e)}),(e=>{let t;t=e&&(e instanceof Error||"string"==typeof e.message)?e.message:"An unexpected error occurred",i({__mozWebExtensionPolyfillReject__:!0,message:t})})).catch((e=>{console.error("Failed to send onMessage rejected reply",e)})),!0})),d=({reject:r,resolve:i},s)=>{e.runtime.lastError?e.runtime.lastError.message===t?i():r(new Error(e.runtime.lastError.message)):s&&s.__mozWebExtensionPolyfillReject__?r(new Error(s.message)):i(s)},m=(e,t,r,...i)=>{if(i.length<t.minArgs)throw new Error(`Expected at least ${t.minArgs} ${a(t.minArgs)} for ${e}(), got ${i.length}`);if(i.length>t.maxArgs)throw new Error(`Expected at most ${t.maxArgs} ${a(t.maxArgs)} for ${e}(), got ${i.length}`);return new Promise(((e,t)=>{const s=d.bind(null,{resolve:e,reject:t});i.push(s),r.sendMessage(...i)}))},u={devtools:{network:{onRequestFinished:g(l)}},runtime:{onMessage:g(h),onMessageExternal:g(h),sendMessage:m.bind(null,"sendMessage",{minArgs:1,maxArgs:3})},tabs:{sendMessage:m.bind(null,"sendMessage",{minArgs:2,maxArgs:3})}},f={clear:{minArgs:1,maxArgs:1},get:{minArgs:1,maxArgs:1},set:{minArgs:1,maxArgs:1}};return r.privacy={network:{"*":f},services:{"*":f},websites:{"*":f}},c(e,u,r)};e.exports=r(chrome)}}(e)}(d);var m=h(d.exports);class u{constructor(e,t,r,i,s){this.wfSecret=e,this.wfAppId=t,this.deviceUrl=r,this.dataUrl=i,this._logger=s}async getWildfireDevice(){return(await fetch(this.deviceUrl,{method:"POST",body:JSON.stringify({}),headers:{"Content-Type":"application/json","WF-Secret":this.wfSecret,"WF-App-ID":this.wfAppId}})).json()}async getActiveDomains(){return(await fetch(`${this.dataUrl}/${this.wfAppId}/active-domain/1`)).json()}async getStanddownPolicy(){const e=`${this.dataUrl}/${this.wfAppId}/stand-down-policy/1`;try{const t=await fetch(e);if(t.ok)return t.json();throw new Error(`Failed to fetch standdown policy. Status ${t.status}`)}catch(t){return this._logger.error("Failed to fetch the standdown policy",{err:t,url:e}),{Domains:[],LostAttribution:[],Params:[],Serp:[]}}}async getMerchantRates(){const e=`${this.dataUrl}/${this.wfAppId}/merchant-rate/1`;try{const t=await fetch(e);if(this._logger.debug("Merchant rates response",{response:t}),!t.ok)throw new Error(`Failed to fetch merchant rates. Status ${t.status}`);const r=t.json();return this._logger.debug("Merchant rates",{rates:r}),r}catch(t){return this._logger.error("Failed to fetch the merchant rates",{err:t,url:e}),[]}}}const f="GIVE_FREELY_",A={async get(e){const t=`${f}${e}`;return(await m.storage.local.get(t))[t]||null},async set(e,t){const r=`${f}${e}`;await m.storage.local.set({[r]:t})},async remove(e){const t=Array.isArray(e)?e.map((e=>`${f}${e}`)):`${f}${e}`;await m.storage.local.remove(t)}},y="wfDevice",p="wfDomains",w="wfStanddownPolicy",v="wfStanddownHistory",E="wfLastCacheRefresh",x="wfMerchantRates";async function C(e,t,r){try{const i=(await S())?.[t];if(i&&i>Date.now())return e.info("Standing down because current affiliate stand down session has not expired"),I(t),!0;await this.refreshCache();const s=await this.getStanddownPolicy();if(P(s,new URL(r).search))return e.info("Standing down because url has affiliate params"),I(t),!0;e.info("No need to stand down.")}catch(t){e.error("Exception produced when trying to determine if it should stand down",t)}return!1}function b(e,t){if(!this.standDownPolicy)return this.logger.warn("Couldnt check affilliation. No stand down policy found"),this.getStanddownPolicy().then((e=>{this.standDownPolicy=e})),!1;const r=e.some((e=>T(this.standDownPolicy,e)))||P(this.standDownPolicy,t);return this.logger.info("Affilliation result:",r),r}const S=async()=>A.get(v),I=async(e,t=1)=>{const r=await S()??{};r[e]=Date.now()+60*t*60*1e3,await A.set(v,r)},T=(e,t)=>{if(!t)return!1;const{Domains:r}=e;return r.some((e=>t.includes(e)))},P=(e,t)=>{if(!t)return!1;const{Params:r}=e;return r.some((e=>t.toLowerCase().includes(`?${e.toLowerCase()}`)))||r.some((e=>t.toLowerCase().includes(`&${e.toLowerCase()}`)))};class U{constructor(e,t,r,i){this.userId=e,this.charityEin=t,this.charityThirdPartyIdentifier=r,this.partnerId=i}toString(){return`userId=${this.encodeUserId(this.userId)},charityEin=${this.charityEin},charityThirdPartyIdentifier=${this.charityThirdPartyIdentifier},partnerId=${this.partnerId}`}encodeUserId(e){return btoa(e).replace(/_/g,"/").replace(/-/g,"+")}}class O{constructor(e,t,r,i=21600){if(this.standDownPolicy=null,this.shouldStandDown=C.bind(this),this.hasAffilliation=b.bind(this),!e||!r)throw new Error("WildfireService requires wildfireClient and vanityBaseUrl");this.wildfireClient=e,this.vanityBaseUrl=r.replace(/\/$/,""),this.refreshInterval=i,this.logger=t}async getActiveDomains(){try{await this.refreshCache();const e=await A.get(p);if(!e)throw Error("Failed to retrieve active domains");return e}catch(e){throw this.logger.error("Failed to get active domains:",e),new Error("Failed to retrieve active domains")}}async getMerchantRates(e){try{await this.refreshCache();const t=await A.get(x);if(!t)throw new Error("Failed to retrieve merchant rates");return t[e]}catch(e){throw this.logger.error("Failed to retrieve merchant rates:",e),new Error("Failed to retrieve merchant rates")}}async generateAffiliateUrl(e,t,r,i){if(!e||!t||!i)throw new Error("Missing required parameters for affiliate URL generation");try{const s=await this.getDevice(),a=await this.generateTrackingCode(r,i,s),n=encodeURIComponent(t),o=encodeURIComponent(a);return`${this.vanityBaseUrl}/e?d=${s.DeviceID}&c=${e.ID}&tc=${o}&url=${n}`}catch(e){throw this.logger.error("Failed to generate affiliate URL:",e),new Error("Failed to generate affiliate URL")}}async clearCache(){try{await Promise.all([A.remove(y),A.remove(p),A.remove(E),A.remove(w),A.remove(x)])}catch(e){throw this.logger.error("Failed to clear cache:",e),new Error("Failed to clear cache")}}async refreshCache(e=!1){try{const t=await A.get(E),r=Date.now();(e||!t||r-t>1e3*this.refreshInterval)&&(await Promise.all([this.syncActiveDomains(),this.syncStanddownPolicy(),this.syncMerchantRates()]),await A.set(E,r)),this.standDownPolicy=await this.getStanddownPolicy()}catch(e){throw this.logger.error("Failed to refresh cache:",e),new Error("Failed to refresh cache")}}async getStanddownPolicy(){return await A.get(w)??(()=>{throw new Error("Failed to retrieve standdown policy. Storage value was null")})()}getRetryOptions(){return{delayFn:e=>1e3*e,maxAttempts:3}}async getDevice(){try{const e=await A.get(y);return e?.DeviceID?e:g((()=>this.fetchAndStoreDevice()),this.getRetryOptions())}catch(e){throw this.logger.error("Failed to get device:",e),new Error("Failed to retrieve device information")}}async fetchAndStoreDevice(){const e=await this.wildfireClient.getWildfireDevice();if(!e?.DeviceID)throw new Error("Failed to retrieve device information");return await A.set(y,e),e}async generateTrackingCode(e,t,r){if(!(e?.id&&e?.charity&&e?.charity.ein&&e?.charity.thirdPartyId)){const e=`notregistered-${r.DeviceID}`;return this.logger.info("User not provided. Using GF's default bucket instead.",e),e}return new U(e.id,e.charity.ein,e.charity.thirdPartyId,t).toString()}async syncActiveDomains(){const e=await g((()=>this.wildfireClient.getActiveDomains()),this.getRetryOptions());return await A.set(p,e),e}async syncStanddownPolicy(){const e=await g((()=>this.wildfireClient.getStanddownPolicy()),this.getRetryOptions());return this.logger.info("Updated standdown policy",e),await A.set(w,e),e}async syncMerchantRates(){const e=await g((()=>this.wildfireClient.getMerchantRates()),this.getRetryOptions());return this.logger.debug("Merchant rates",e),await A.set(x,e),e}}class _{constructor(e){this.partnerApiKey=e,this.partnerConfig=null,this.globalConfig=null,this.lastConfigRefresh=0,this.CONFIG_REFRESH_INTERVAL=3e5,this.PARTNER_CONFIG_STORAGE_KEY="gf_partner_config",this.GLOBAL_CONFIG_STORAGE_KEY="gf_global_config"}getRetryOptions(){return{delayFn:e=>1e3*e,maxAttempts:3}}async fetchAndUpdatePartnerConfig(){const e=await g((async()=>{const e=await fetch(`https://cdn.givefreely.com/adunit/config/${this.partnerApiKey}.json`,{cache:"no-store"});if(!e.ok)throw new Error(`Failed to fetch partner config: ${e.statusText}`);return e.json()}),this.getRetryOptions()),t={config:e,lastRefresh:Date.now()};return await A.set(this.PARTNER_CONFIG_STORAGE_KEY,t),e}async fetchAndUpdateGlobalConfig(){const e=await g((async()=>{const e=await fetch("https://cdn.givefreely.com/adunit/config/global.json",{cache:"no-store"});if(!e.ok)throw new Error(`Failed to fetch global config: ${e.statusText}`);return e.json()}),this.getRetryOptions()),t={config:e,lastRefresh:Date.now()};return await A.set(this.GLOBAL_CONFIG_STORAGE_KEY,t),e}async getConfig(){const e=Date.now(),t=await A.get(this.PARTNER_CONFIG_STORAGE_KEY),r=await A.get(this.GLOBAL_CONFIG_STORAGE_KEY);if(this.partnerConfig=t?.config||null,this.globalConfig=r?.config||null,this.lastConfigRefresh=Math.max(t?.lastRefresh||0,r?.lastRefresh||0),!this.partnerConfig||!this.globalConfig||e-this.lastConfigRefresh>this.CONFIG_REFRESH_INTERVAL)try{const[t,r]=await Promise.all([this.fetchAndUpdatePartnerConfig(),this.fetchAndUpdateGlobalConfig()]);this.partnerConfig=t,this.globalConfig=r,this.lastConfigRefresh=e}catch(e){if(!this.partnerConfig||!this.globalConfig)throw e}const i=this.mergeConfigs(this.globalConfig,this.partnerConfig);return((e,t,r)=>{const i=[...t.merchantExclusions??[],...r.merchantExclusions??[]];e.merchantExclusions=i})(i,this.globalConfig,this.partnerConfig),i}async clearCache(){await Promise.all([A.remove(this.PARTNER_CONFIG_STORAGE_KEY),A.remove(this.GLOBAL_CONFIG_STORAGE_KEY)]),this.partnerConfig=null,this.globalConfig=null,this.lastConfigRefresh=0}mergeConfigs(e,t){if(!t)return e;const r={...e};return Object.keys(t).forEach((i=>{if(!Object.prototype.hasOwnProperty.call(t,i))return;const s=e[i],a=t[i];Array.isArray(a)&&Array.isArray(s)?r[i]=a:r[i]=null===a||"object"!=typeof a||"object"!=typeof s?void 0!==a?a:s:this.mergeConfigs(s,a)})),r}getStoredState(e){return e?{config:e.config,lastRefresh:e.lastRefresh}:{config:null,lastRefresh:0}}}const D="TRACK_EVENT",k="GF_HIDE_POPUP",F="GF_GET_POPUP_CONFIG",R="GF_IS_ACTIVE_DOMAIN",N="GF_SHOULD_STAND_DOWN",L="GF_ACTIVATE_OFFER",G="GF_STORE_SHOPIFY_SHOP_ID",$="GF_GET_DOMAIN_BY_SHOP_ID",M="shopify_shop_ids",K="gf_last_health_check";class H{static register(e,t){this.strategies.set(e,t)}static get(e){return this.strategies.get(e)}static exists(e){return!!function(e){return"object"==typeof e&&null!==e&&"type"in e&&"payload"in e&&"string"==typeof e.type}(e)&&this.strategies.has(e.type)}}H.strategies=new Map;class j{async handle(e,t){const{hostname:r}=e.payload,{giveFreelyService:i}=t,s=i.getLogger(),a=await i.getConfig().merchantExclusions,n=await i.getActiveDomains();s.debug("Checking hostname",{hostname:r});try{if(i.healthCheck(),a.some((e=>e.disableDomain&&(r===e.domain||r.endsWith(`.${e.domain}`)))))return s.debug("Hostname is in merchant exclusions",{hostname:r}),{type:R,payload:{isActive:!1,domain:void 0,rates:[]}};if(!n||0===n.length)throw new Error("No active domains");s.debug("Retrieved active domains",{count:n.length});const e=n.find((e=>r===e.Domain||r.endsWith(`.${e.Domain}`)));s.debug("Domain check result",{hostname:r,isActive:!!e});let t=[];if(e?.ID){const r=await i.getMerchantRates(e.Merchant.ID);r&&(s.debug("Retrieved merchant rates",{merchantRates:r}),t=r)}return{type:R,payload:{isActive:!!e,domain:e,rates:t}}}catch(e){return s.error("Error checking domain",{hostname:r,error:e}),{type:R,payload:{isActive:!1,domain:void 0,rates:[]}}}}}class z{async handle(e,t){const{giveFreelyService:r}=t,i=r.getLogger(),s=await r.getCachedConfig();try{return i.debug("Fetching popup config"),{type:F,payload:{config:s}}}catch(e){return i.error("Error fetching popup config",{error:e}),{type:F,payload:{config:null}}}}}class Y{async handle(e,t){const{days:r}=e.payload,{giveFreelyService:i}=t,s=i.getLogger();try{const e=new Date;return e.setDate(e.getDate()+r),await A.set("popup_hide",{popupHide:e.getTime()}),s.debug("Popup hidden",{days:r,expiry:e}),{type:k,payload:{ack:!0}}}catch(e){return s.error("Error hiding popup",{days:r,error:e}),{type:k,payload:{ack:!1}}}}}class W{async handle(e,t){const{activeDomain:r,url:i}=e.payload,{giveFreelyService:s}=t,a=s.getLogger();a.debug("Checking if we should stand down",{activeDomain:r});try{const e=await s.shouldStandDown(r,i);return{type:N,payload:{result:e}}}catch(e){return a.error("Error checking if we should stand down. Returning false",{activeDomain:r,error:e}),{type:N,payload:{result:!1}}}}}const B="version",q=()=>String("1.5.1");class V{constructor(e,t,r=60){this._config=null,this.track=async(e,t,r,i=!1)=>{null===this._config&&(this._config=await new _(this._partnerApiKey).getConfig());const s={partner:`adUnit_${this._partnerApiKey}`,eventType:e,eventData:{userId:i?void 0:this._userService?.user?.id,libVersion:q(),wfDeviceId:t,...r}};try{const e=JSON.stringify(s);return await this.shouldBroadcastEvent(e)?(await fetch(this._config.eventsUrl,{headers:{"Content-Type":"application/json"},method:"POST",body:e,cache:"no-store"}),await this.pushEventToHistory(e),!0):(this._logger.info("This event has already been broadcasted during the past hour",s),!1)}catch(e){return this._logger.info("Something unexpected happened when dispatching a gf event",{error:e,event:s}),!1}},this.getEventsHistory=async()=>{const{GF_AD_EVENT_HISTORY:e}=await l.storage.local.get({GF_AD_EVENT_HISTORY:""}),t=(e=>{const t=new Date;return t.setTime(t.getTime()+60*e*1e3),t.getTime()})(-this._debounceWindowInMinutes),r=(e||[]).filter((e=>e.createdAt>t));return await l.storage.local.set({GF_AD_EVENT_HISTORY:r}),r},this.shouldBroadcastEvent=async e=>!(await this.getEventsHistory()).some((t=>t.payload===e)),this.pushEventToHistory=async e=>{const t=await this.getEventsHistory();t.push({createdAt:Date.now(),payload:e}),await l.storage.local.set({GF_AD_EVENT_HISTORY:t})},this._partnerApiKey=e,this._userService=t,this._debounceWindowInMinutes=r,this._logger=n.getInstance({title:"Analytics"})}}V.trackEvent=async(e,t,r=!1)=>{await async function(e){return new Promise(((t,r)=>{try{const i=i=>chrome.runtime.lastError?r({error:chrome.runtime.lastError,message:e}):t(i);l.runtime.sendMessage(e,i)}catch(e){r(e)}}))}({type:D,payload:{eventType:e,eventData:t,anonymous:r}})};class X{async handle(e,t){const{eventType:r,eventData:i,anonymous:s}=e.payload,{giveFreelyService:a}=t,n=a.getLogger();n.debug("Broadcasting event",{eventType:r,eventData:i,anonymous:s});try{const e=await a.trackEvent(r,i,s);return{type:D,payload:{result:e}}}catch(e){return n.error("Error broadcasting event. Returning false",{eventType:r,eventData:i,error:e}),{type:D,payload:{result:!1}}}}}class Z{async handle(e,t){const{activeDomain:i,originalUrl:s,selectedCharity:a}=e.payload,{giveFreelyService:n}=t,o=n.getLogger();o.debug("Activating offer",{activeDomain:i,selectedCharity:a});try{if(!a?.ein||!a?.thirdPartyId)throw new Error("Missing charity information");const e=await n.initializeWfDeviceId();if(!e)throw new Error("Failed to initialize Wildfire device ID");const t=await n.upsertUser(a,e);o.debug("Upserted user",{currentUser:t}),t||o.info("Failed to create user. Using default bucket's user");const r=await n.generateAffiliateUrl(i,s,t);return o.debug("Generated affiliate URL",{affiliateUrl:r}),(async e=>{const t=l.tabs.getCurrent(),r=await t,i=await l.tabs.create({url:e,openerTabId:r?.id,active:!1,pinned:!0});await(async e=>new Promise((t=>{l.tabs.onUpdated.addListener((async function r(i,s){if(i===e&&"complete"===s.status){if(l.tabs.onUpdated.removeListener(r),!(await l.tabs.get(e)).url)return void t(!1);t(!0)}}))})))(i.id)&&setTimeout((()=>{i?.id&&l.tabs.remove(i.id)}),3e4)})(r),await n.updateStanddownHistory(i.Domain),o.debug("Activated offer",{activeDomain:i,selectedCharity:a}),{type:L,payload:{response:!0}}}catch(e){return o.error("Error activating offer",{activeDomain:i,error:e}),n.trackEvent(r.checkoutPopupFailedActivation,{activeDomain:i,error:e}),{type:L,payload:{response:!1}}}}}var J;!function(e){e[e.Pending=0]="Pending",e[e.Ready=1]="Ready",e[e.Received=2]="Received",e[e.Donated=3]="Donated",e[e.Disqualified=4]="Disqualified"}(J||(J={}));class Q{constructor(e,t,r){this.adUnitId=e,this.config=t,this.logger=r}async getAnonymousUserCommissions(e,t){try{const r=new URLSearchParams(t).toString(),i=await fetch(`${this.config.apiConfig.baseUri}/${this.config.apiConfig.getAnonymousUserComissionsPath}?${r}`,{method:"GET",headers:{"Content-Type":"application/json","X-AnonymousUserToken":e}});if(!i.ok)throw new Error("Failed to fetch commissions");return await i.json()}catch(e){throw this.logger.error("[GiveFreelyApiClient] Error fetching anonymous user's commissions:",{error:e}),e}}async createOrUpdateAnonymousUser(e,t){try{const r=await fetch(`${this.config.apiConfig.baseUri}/${this.config.apiConfig.createAnonymousUserPath}?adUnitId=${this.adUnitId}`,{method:"PUT",headers:{"Content-Type":"application/json","X-GF-Platform":"adUnitLibrary","X-AnonymousUserToken":t??""},body:JSON.stringify(e)});if(!r.ok)throw new Error("Failed to create/update anonymous user");this.logger.info("[GiveFreelyApiClient] anonymous user created/updated succesfuly.");const i=await r.json(),s=r.headers.get("X-AnonymousUserToken");return{resultUser:{...i,charity:{ein:i.selectedCharity,thirdPartyId:i.selectedCharityThirdPartyIdentifier,name:void 0}},resultToken:s}}catch(e){throw this.logger.error("[GiveFreelyApiClient] Error creating anonymous user:",{error:e}),e}}}class ee{constructor(e,t){this.ANONYMOUS_USER_STORAGE_KEY="gf_anonymous_user_info",this.ANONYMOUS_ENCRIPTED_TOKEN_STORAGE_KEY="gf_anonymous_encrypted_token",this._giveFreelyApiClient=e,this._logger=t,this.user=null}async resetUser(){await A.remove(this.ANONYMOUS_ENCRIPTED_TOKEN_STORAGE_KEY),await A.remove(this.ANONYMOUS_USER_STORAGE_KEY)}async upsertUser(e,t){let r=await this.fetchUser();try{const i={selectedCharity:e?.ein,selectedCharityThirdPartyIdentifier:e?.thirdPartyId,deviceId:t};if(!await this.shouldCreateOrUpdateUser(r,i))return r;const s=await A.get(this.ANONYMOUS_ENCRIPTED_TOKEN_STORAGE_KEY),{resultUser:a,resultToken:n}=await this._giveFreelyApiClient.createOrUpdateAnonymousUser(i,s);n&&await A.set(this.ANONYMOUS_ENCRIPTED_TOKEN_STORAGE_KEY,n),a&&(await A.set(this.ANONYMOUS_USER_STORAGE_KEY,a),r=a)}catch(e){this._logger.error("Error creating/updating anonymous user:",e)}return this.user=r,r}async fetchUser(){const e=await A.get(this.ANONYMOUS_USER_STORAGE_KEY);return this.user=e,e}async shouldCreateOrUpdateUser(e,t){return!e||e.charity?.ein!==t.selectedCharity||e.charity?.thirdPartyId!==t.selectedCharityThirdPartyIdentifier||e.deviceId!==t.deviceId}}const te=e=>{try{return new URL(e),!0}catch{return!1}},re=new Set,ie=new Set,se={urls:["<all_urls>"],types:["main_frame"]};class ae{async handle(e,t){const r=e.payload,{giveFreelyService:i}=t,s=i.getLogger();try{const e=M,t=await A.get(e)||[],i=t.findIndex((e=>e.shopId===r.shopId));return i>=0?t[i]=r:t.push(r),await A.set(e,t),s.debug("Stored Shopify shop ID",{shopInfo:r}),{type:G,payload:{success:!0}}}catch(e){return s.error("Error storing Shopify shop ID",{shopInfo:r,error:e}),{type:G,payload:{success:!1}}}}}class ne{async handle(e,t){const{shopId:r}=e.payload,{giveFreelyService:i}=t,s=i.getLogger();try{const e=M,t=(await A.get(e)||[]).find((e=>e.shopId===r));return t?(s.debug("Found domain for shop ID",{shopId:r,domain:t.domain}),{type:$,payload:{found:!0,domain:t.domain,shopInfo:t}}):(s.debug("No domain found for shop ID",{shopId:r}),{type:$,payload:{found:!1}})}catch(e){return s.error("Error getting domain for shop ID",{shopId:r,error:e}),{type:$,payload:{found:!1}}}}}class oe{constructor(e,t){this.lastCheck=null,this.trackEvent=e,this.logger=t}async initialize(){const e=await A.get(K);e&&(this.lastCheck=e)}getToday(){return(new Date).toISOString().split("T")[0]}async check(){try{const e=this.lastCheck??0,t=this.getToday();(e?new Date(e).toISOString().split("T")[0]:null)!==t&&(this.lastCheck=Date.now(),await A.set(K,this.lastCheck),await this.trackEvent(r.checkoutPopupHealthCheck,{language:chrome.i18n.getUILanguage()}))}catch(e){this.logger.error("Health check failed",{error:e instanceof Error?e.message:"Unknown error"})}}}const ce=n.getInstance(),ge="countryCode";class le extends Error{constructor(e="Service not initialized"){super(e),this.name="UninitializedServiceError"}}e.GiveFreelyService=class{constructor(e){this.partnerApiKey=e,this.dependencies={configService:new _(e)},this.logger=n.getInstance(),this.logger.configure({enabled:!0,title:"Background - GiveFreelyService"}),this.state={initialized:!1,wildfireService:null,partnerFilter:null,config:null,wfDeviceId:null,analytics:null,giveFreelyUserService:null,partnerApiKey:e,healthCheck:null}}assertInitialized(){if(!this.state.initialized)throw new le}async initialize(e=async()=>(this.logger.debug("Using default partnerFilter."),!0)){if(!this.state.initialized)try{const t=await this.dependencies.configService.getConfig();this.logger.configure({minLevel:t.backgroundMinLogLevel??"error"}),this.logger.info("Initializing GiveFreelyService",{partnerApiKey:this.partnerApiKey});const r=this.createWildfireService(t),i=await(async(e=!0)=>{const t=await A.get(B),r=await q(),i=t!==r;var s;return e&&i&&await(s=r,A.set(B,s)),i})();i&&this.logger.info("New version detected."),this.state.healthCheck=new oe(this.trackEvent.bind(this),this.logger),await this.state.healthCheck.initialize(),await r.refreshCache(i);const a=new Q(this.partnerApiKey,t,this.logger);this.state.giveFreelyUserService=new ee(a,this.logger),await this.state.giveFreelyUserService.fetchUser(),this.state.giveFreelyUserService.user?.id||await this.state.giveFreelyUserService.upsertUser();try{await(async()=>await A.get(ge)||(async()=>{ce.debug("detecting country");const e={method:"GET",headers:{"Content-Type":"application/json",Authorization:"Basic OTEzOTkxOnFlYmpaWF9DOGNRY0lxSHA4WTVjNGxzU1pRSlM2VW9MMExzTF9tbWs="}};try{const t=await fetch("https://geoip.maxmind.com/geoip/v2.1/country/me",e);if(ce.debug("Received geolocation response",{status:t.status}),!t.ok)return void ce.warn("Failed to get geolocation data",{status:t.status});const r=await t.json();if(!r)throw new Error("There was an error fetching geoip look up");return await A.set(ge,r.country.iso_code),r.country.iso_code}catch(e){return void ce.error("Failed to get geolocation data",{error:e})}})())()}catch(e){this.logger.debug("Failed to get geolocation data",{error:e})}this.state.analytics=new V(this.partnerApiKey,this.state.giveFreelyUserService),this.logger.addTransport(new s(this)),H.register(R,new j),H.register(F,new z),H.register(k,new Y),H.register(N,new W),H.register(D,new X),H.register(L,new Z),H.register(G,new ae),H.register($,new ne),this.state.wildfireService=r,this.state.partnerFilter=e,this.state.config=t,this.state.initialized=!0,m.webRequest&&(m.webRequest.onBeforeRequest.addListener((e=>{const t=e.getLogger();return({requestId:r,url:i,initiator:s})=>{try{if(re.has(r)||ie.has(r)||!te(i))return;const{hostname:a,search:n}=new URL(i);if(a.includes("wild.link"))return t.info("Cashback activation request identified, ignoring affiliate check for request"),void ie.add(r);let o;s&&te(s)&&(o=new URL(s).hostname),e.hasAffiliation([a,o],n)&&(t.info("Affiliation found on url, adding request id to track"),re.add(r))}catch(e){t.error("Error on handleAffiliateOnBeforeRequest",e)}}})(this),se),m.webRequest.onBeforeRedirect.addListener((e=>{const t=e.getLogger();return async({requestId:r,redirectUrl:i})=>{try{if(!re.has(r))return;t.info("Attempting to find active domain");const{hostname:s}=new URL(i),a=(await e.getActiveDomains()).find((e=>s===e.Domain||s.endsWith(`.${e.Domain}`)));if(!a)return;t.info("Found active domain. Updating standdown state"),await I(a.Domain)}catch(e){t.error("Error on handleAffiliateOnBeforeRedirect",e)}}})(this),se),m.webRequest.onCompleted.addListener((()=>{const e=this.getLogger();return({requestId:t})=>{try{re.has(t)&&(e.info("Tracking request completed. Request Id:",t),re.delete(t))}catch(t){e.error("Error on handleAffiliateOnCompleted",t)}}})(),se)),function(e){const t=n.getInstance();l.runtime.onMessage.addListener(((r,i,s)=>{function a(e){s(e)}const n=e(r,0);return n instanceof Promise?(n.then((e=>{e&&a(e)})).catch((e=>{t.warn("Async message callback error:",e)})),!0):n}))}((async(e,t)=>(this.logger.debug("Received message",{type:e.type,payload:e.payload}),this.handleMessage(e)))),this.logger.info("GiveFreelyService initialized successfully")}catch(e){const t=e instanceof Error?e.message:"Unknown error";throw this.logger.error("Failed to initialize GiveFreelyService",{error:t}),new Error(`Failed to initialize GiveFreelyService: ${t}`)}}getConfig(){return this.assertInitialized(),this.state.config}async getCachedConfig(){return this.state.config=await this.dependencies.configService.getConfig(),this.logger.configure({minLevel:this.state.config.backgroundMinLogLevel??"error"}),this.state.config}async getActiveDomains(){return this.assertInitialized(),this.state.wildfireService.getActiveDomains()}async shouldStandDown(e,t){this.assertInitialized();const r=new URL(t);if(!await this.state.partnerFilter(r.hostname))return this.logger.info("Should standdown due to partner filter."),!0;if(this.getConfig().merchantExclusions.some((t=>t.mutePopups&&e===t.domain)))return this.logger.info("Should standdown due to merchant exclusions"),!0;const i=await this.state.wildfireService.shouldStandDown(this.logger,e,t);return i&&this.logger.info("Should standdown due to vendor policy"),i}hasAffiliation(e,t){if(!this.state.wildfireService)return this.logger.warn("Wildfire service not initialized yet"),!1;const r=this.state.wildfireService.hasAffilliation(e,t);return r&&this.logger.info("Affiliation identified"),r}trackEvent(e,t,r=!1){return this.assertInitialized(),this.state.analytics.track(e,this.state.wfDeviceId?.DeviceID,t,r)}getLogger(){return this.assertInitialized(),this.logger}async initializeWfDeviceId(){if(this.assertInitialized(),this.state.wfDeviceId=await this.state.wildfireService.getDevice(),!this.state.wfDeviceId)throw new Error("Failed to initialize Wildfire device ID");return this.state.wfDeviceId.DeviceID}getWfDeviceId(){return this.assertInitialized(),this.state.wfDeviceId.DeviceID}upsertUser(e,t){return this.assertInitialized(),this.state.giveFreelyUserService.upsertUser(e,t)}getCurrentUser(){return this.assertInitialized(),this.state.giveFreelyUserService.user}generateAffiliateUrl(e,t,r){return this.assertInitialized(),this.state.wildfireService.generateAffiliateUrl(e,t,r,this.state.partnerApiKey)}updateStanddownHistory(e){return this.assertInitialized(),I(e)}getMerchantRates(e){if(this.assertInitialized(),!this.state.wildfireService)throw new Error("Wildfire service not initialized");return this.state.wildfireService.getMerchantRates(e)}async healthCheck(){this.assertInitialized(),await this.state.healthCheck.check()}async handleMessage(e){this.assertInitialized();const t=H.get(e.type);if(!t)return;const r={giveFreelyService:this};return t.handle(e,r)}createWildfireService(e){this.logger.debug("config",this.state.config);const t=new u(e.wfSecret,e.wfAppId,e.deviceUrl,e.dataUrl,this.logger);return new O(t,this.logger,e.vanityBaseUrl,e.refreshInterval)}async destroy(){this.logger.info("Destroying GiveFreelyService"),await Promise.all([this.dependencies.configService.clearCache(),this.state.wildfireService?.clearCache(),this.state.giveFreelyUserService?.resetUser()]),this.state.initialized=!1,this.state.wildfireService=null,this.state.partnerFilter=null,this.state.analytics=null,this.state.config=null}},e.browser=l,e.isAdUnitMessage=e=>H.exists(e)}));
